<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Therapieplan â€“ EC q2w</title>

<style>
  body { font-family: system-ui, sans-serif; background:#f3f4f6; padding:2rem; }
  .container { max-width:1100px; margin:auto; }

  form, .plan {
    background:#fff; padding:1.5rem; border-radius:12px; margin-bottom:2rem;
    box-shadow:0 10px 25px rgba(0,0,0,0.08);
  }

  label { font-weight:600; font-size:0.85rem; display:block; }
  input, button { width:100%; padding:0.6rem; margin-top:0.25rem; }
  button {
    background:#dc2626; color:#fff; border:none; border-radius:8px;
    font-weight:600; cursor:pointer;
  }

  /* ===== Graphic Schedule ===== */
  .cycle-title { font-weight:700; margin-bottom:0.5rem; }

  .weekday-header {
    display:grid; grid-template-columns:repeat(7, 1fr);
    margin-bottom:6px; text-align:center;
    font-size:0.75rem; font-weight:600; color:#374151;
  }

  .grid { display:grid; grid-template-columns:repeat(7, 1fr); gap:6px; }

  .day {
    border:1px solid #e5e7eb; border-radius:6px; min-height:95px;
    background:#f9fafb; position:relative; padding:6px;
    display:flex; align-items:stretch; justify-content:center;
  }
  .day.weekend { background:#e5e7eb; }

  .day-label {
    position:absolute; bottom:4px; right:6px;
    font-size:0.65rem; font-weight:600; color:#6b7280;
  }

  /* ===== EC Bars ===== */
  .therapy-bars {
    display:flex; gap:8px; height:100%; width:65%;
    align-items:stretch; justify-content:center; padding:6px 0;
  }
  .bar {
    flex:1; border-radius:6px; display:flex;
    align-items:center; justify-content:center;
    font-size:0.75rem; font-weight:700; color:#fff;
  }
  .bar.e { background:#dc2626; }
  .bar.c { background:#2563eb; }

  /* ===== Icons bottom-aligned ===== */
  .icon-block { margin-top:auto; text-align:center; padding-bottom:6px; }
  .icon { font-size:2.2rem; line-height:1; }
  .icon-label { font-size:0.7rem; margin-top:4px; color:#374151; font-weight:600; }

  /* ===== Table ===== */
  table { width:100%; border-collapse:collapse; margin-top:1rem; }
  th, td { padding:0.5rem; border-bottom:1px solid #e5e7eb; text-align:left; }

  @media print { form, button { display:none; } body { background:#fff; } }
</style>
</head>

<body>
<div class="container">

<h1>Therapieplan EC q2w</h1>

<form id="therapyForm">
  <label>Vorname<input id="vorname" required></label>
  <label>Nachname<input id="nachname" required></label>
  <label>Geburtsdatum (optional)<input id="geburt" placeholder="TT.MM.JJJJ"></label>
  <label>Startdatum Zyklus 1<input type="date" id="startdatum" required></label>
  <button>Plan berechnen</button>
</form>

<div class="plan" id="plan" style="display:none">
  <h2>Grafische Ãœbersicht (ein Zyklus)</h2>
  <div id="graphic"></div>

  <h2 style="margin-top:2rem">Tabellarische Ãœbersicht (alle Zyklen)</h2>
  <div id="table"></div>

  <button onclick="window.print()">Drucken / PDF</button>
</div>

</div>

<script type="application/json" id="schema-EC-q2w">
{
  "name": "EC q2w",
  "zyklus_tage": 14,
  "anzahl_zyklen": 4,
  "events": [
    { "label": "EC", "type": "therapy", "day": 1 },
    { "label": "Pegfilgrastim", "type": "injection", "day": 2 },
    { "label": "Labor", "type": "lab", "day": 8 },
    { "label": "Labor", "type": "lab", "workdays_before_next_cycle_start": 2 }
  ]
}
</script>

<script>
/* ===== Geburtsdatum (optional, aber valide) ===== */
function isValidBirthdate(value) {
  if (!value) return true;
  const m = value.match(/^(\d{2})\.(\d{2})\.(\d{4})$/);
  if (!m) return false;
  const day = parseInt(m[1],10);
  const month = parseInt(m[2],10)-1;
  const year = parseInt(m[3],10);
  const d = new Date(year, month, day);
  if (d.getFullYear()!==year || d.getMonth()!==month || d.getDate()!==day) return false;
  if (d > new Date()) return false;
  return true;
}

/* ===== Helpers ===== */
const addDays = (d,n) => { const x=new Date(d); x.setDate(x.getDate()+n); return x; };
const fmt = d => d.toLocaleDateString("de-DE");
const weekdays = ["Sonntag","Montag","Dienstag","Mittwoch","Donnerstag","Freitag","Samstag"];

function subtractWorkdays(date, n){
  const x = new Date(date);
  while(n>0){
    x.setDate(x.getDate()-1);
    const w = x.getDay();
    if(w!==0 && w!==6) n--;
  }
  return x;
}

/* ===== Cycle Calculation ===== */
function calculateCycles(start, schema){
  const all = [];
  for(let c=0; c<schema.anzahl_zyklen; c++){
    const cycleStart = addDays(start, c*schema.zyklus_tage);
    const nextCycleStart = addDays(cycleStart, schema.zyklus_tage); // âœ… wichtig!
    const cycleEnd = addDays(cycleStart, schema.zyklus_tage-1);

    const days = [...Array(schema.zyklus_tage)].map((_,i)=>({
      day: i+1,
      date: addDays(cycleStart, i),
      events: []
    }));

    schema.events.forEach(ev=>{
      let dayIndex = null;

      if (ev.day) {
        dayIndex = ev.day; // 1..zyklus_tage
      }

      if (ev.workdays_before_next_cycle_start) {
        const targetDate = subtractWorkdays(nextCycleStart, ev.workdays_before_next_cycle_start);
        dayIndex = Math.round((targetDate - cycleStart) / (1000*60*60*24)) + 1;
      }

      if (dayIndex && dayIndex >= 1 && dayIndex <= schema.zyklus_tage) {
        days[dayIndex-1].events.push(ev);
      }
    });

    all.push({ cycle: c+1, cycleStart, cycleEnd, nextCycleStart, days });
  }
  return all;
}

/* ===== UI ===== */
document.getElementById("therapyForm").addEventListener("submit", e => {
  e.preventDefault();

  const geburt = document.getElementById("geburt").value.trim();
  if (!isValidBirthdate(geburt)) {
    alert("Bitte ein gÃ¼ltiges Geburtsdatum im Format TT.MM.JJJJ eingeben.");
    document.getElementById("geburt").focus();
    return;
  }

  const start = new Date(document.getElementById("startdatum").value);
  const schema = JSON.parse(document.getElementById("schema-EC-q2w").textContent);

  const cycles = calculateCycles(start, schema);
  const c1 = cycles[0];

  /* Header */
  let header = `<div class="weekday-header">`;
  c1.days.slice(0,7).forEach(d => {
    header += `<div>${weekdays[d.date.getDay()]}</div>`;
  });
  header += `</div>`;

  /* Grid */
  let grid = `<div class="grid">`;
  c1.days.forEach(d => {
    const weekend = d.date.getDay()===0 || d.date.getDay()===6;
    grid += `<div class="day ${weekend ? 'weekend' : ''}">`;

    d.events.forEach(ev => {
      if (ev.type==="therapy") {
        grid += `
          <div class="therapy-bars">
            <div class="bar e">E</div>
            <div class="bar c">C</div>
          </div>`;
      }
      if (ev.type==="injection") {
        grid += `
          <div class="icon-block">
            <div class="icon">ðŸ’‰</div>
            <div class="icon-label">${ev.label}</div>
          </div>`;
      }
      if (ev.type==="lab") {
        grid += `
          <div class="icon-block">
            <div class="icon">ðŸ©¸</div>
            <div class="icon-label">${ev.label}</div>
          </div>`;
      }
    });

    if (d.day===1 || d.day===8) {
      grid += `<div class="day-label">d${d.day}</div>`;
    }

    grid += `</div>`;
  });
  grid += `</div>`;

  document.getElementById("graphic").innerHTML =
    `<div class="cycle-title">Zyklus 1</div>${header}${grid}`;

  /* Table (alle Zyklen, mit Datum) */
  let table = `
    <table>
      <tr>
        <th>Zyklus</th>
        <th>Datum</th>
        <th>Tag</th>
        <th>MaÃŸnahme</th>
      </tr>`;

  cycles.forEach(cyc => {
    cyc.days.forEach(d => {
      d.events.forEach(ev => {
        table += `
          <tr>
            <td>${cyc.cycle}</td>
            <td>${fmt(d.date)}</td>
            <td>d${d.day}</td>
            <td>${ev.label}</td>
          </tr>`;
      });
    });
  });

  table += `</table>`;
  document.getElementById("table").innerHTML = table;

  document.getElementById("plan").style.display = "block";
});
</script>
</body>
</html>