<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Therapieplan ‚Äì EC q2w</title>

<style>
  body { font-family: system-ui, sans-serif; background:#f3f4f6; padding:2rem; }
  .container { max-width:1100px; margin:auto; }

  form, .plan {
    background:#fff; padding:1.5rem; border-radius:12px; margin-bottom:2rem;
    box-shadow:0 10px 25px rgba(0,0,0,0.08);
  }

  label { font-weight:600; font-size:0.85rem; display:block; }
  input, button { width:100%; padding:0.6rem; margin-top:0.25rem; }
  button {
    background:#dc2626; color:#fff; border:none; border-radius:8px;
    font-weight:600; cursor:pointer;
  }

  .warning { color:#dc2626; font-weight:600; }

  /* ===== Graphic ===== */
  .weekday-header{
    display:grid; grid-template-columns:repeat(7,1fr);
    text-align:center; font-weight:600; font-size:0.75rem;
    margin-bottom:6px; color:#374151;
  }
  .grid{ display:grid; grid-template-columns:repeat(7,1fr); gap:6px; }
  .day{
    border:1px solid #e5e7eb; border-radius:6px;
    min-height:95px; padding:6px;
    background:#f9fafb; position:relative;
    display:flex; justify-content:center; align-items:stretch;
  }
  .day.weekend{ background:#e5e7eb; }
  .day.holiday{ outline:2px solid #dc2626; outline-offset:-2px; }
  .day-label{
    position:absolute; bottom:4px; right:6px;
    font-size:0.65rem; font-weight:600; color:#6b7280;
  }

  /* Therapy bars */
  .therapy-bars{
    display:flex;
    gap:6px;
    width:70%;
    height:100%;
  }
  .bar{
    flex:1;
    border-radius:6px;
    display:flex;
    align-items:center;
    justify-content:center;
    font-weight:700;
    color:#fff;
    font-size:0.75rem;
    writing-mode:horizontal-tb;
    text-align:center;
  }

  /* Icons */
  .icon-block{ margin-top:auto; text-align:center; padding-bottom:6px; }
  .icon{ font-size:2.2rem; line-height:1; }
  .icon-label{ font-size:0.7rem; font-weight:600; color:#374151; margin-top:4px; }

  /* ===== Table ===== */
  table{ width:100%; border-collapse:collapse; margin-top:1rem; }
  th, td{ padding:0.5rem; border-bottom:1px solid #e5e7eb; text-align:left; }

  @media print { form, button { display:none; } body { background:#fff; } }
</style>
</head>

<body>
<div class="container">
  <h1 id="title">Therapieplan</h1>

  <form id="therapyForm">
    <label>Vorname<input id="vorname" required></label>
    <label>Nachname<input id="nachname" required></label>
    <label>Geburtsdatum (optional, TT.MM.JJJJ)
      <input id="geburt" placeholder="TT.MM.JJJJ">
    </label>
    <label>Chemotherapie-Schema<select id="schemaSelect" required></select></label>
    <label>Startdatum Zyklus 1
      <input type="date" id="startdatum" required>
    </label>
    <button type="submit">Plan berechnen</button>
  </form>

  <div class="plan" id="plan" style="display:none">
    <h2>Grafische √úbersicht (1 Zyklus)</h2>
    <div id="graphic"></div>

    <h2 style="margin-top:2rem">Tabellarische √úbersicht (alle Zyklen)</h2>
    <div id="patient"></div>
    <div id="table"></div>

    <button onclick="window.print()">Drucken / PDF</button>
  </div>
</div>

<script type="application/json" id="schemas">
{
  "EC_q2w": {
    "label": "EC q2w",
    "zyklus_tage": 14,
    "anzahl_zyklen": 4,
    "events": [
      {
        "type": "therapy",
        "drug": "Epirubicin",
        "short": "E",
        "color": "#dc2626",
        "day": 1
      },
      {
        "type": "therapy",
        "drug": "Cyclophosphamid",
        "short": "C",
        "color": "#2563eb",
        "day": 1
      },
      {
        "type": "injection",
        "label": "Pegfilgrastim",
        "day": 2
      },
      {
        "type": "lab",
        "label": "Labor",
        "day": 8
      },
      {
        "type": "lab",
        "label": "Labor",
        "workdays_before_next_cycle_start": 2
      }
    ]
  },

  "Paclitaxel_qw": {
    "label": "Paclitaxel w√∂chentlich",
    "zyklus_tage": 7,
    "anzahl_zyklen": 12,
    "events": [
      {
        "type": "therapy",
        "drug": "Paclitaxel",
        "short": "P",
        "color": "#059669",
        "day": 1
      },
      {
        "type": "lab",
        "label": "Labor",
        "workdays_before_next_cycle_start": 2
      }
    ]
  }
}
</script>

<script>
/* ===== SELECT bef√ºllen ===== */
const schemas = JSON.parse(
  document.getElementById("schemas").textContent
);

const schemaSelect = document.getElementById("schemaSelect");

// Dropdown bef√ºllen
Object.entries(schemas).forEach(([key, schema]) => {
  const opt = document.createElement("option");
  opt.value = key;
  opt.textContent = schema.label;
  schemaSelect.appendChild(opt);
});

/* ===== DOM ===== */
const formEl     = document.getElementById("therapyForm");
const vornameEl  = document.getElementById("vorname");
const nachnameEl = document.getElementById("nachname");
const geburtEl   = document.getElementById("geburt");
const startEl    = document.getElementById("startdatum");

const planEl     = document.getElementById("plan");
const graphicEl  = document.getElementById("graphic");
const patientEl  = document.getElementById("patient");
const tableEl    = document.getElementById("table");



/* ===== Geburtsdatum ===== */
function isValidBirthdate(value){
  if (!value) return true;
  const m = value.match(/^(\d{2})\.(\d{2})\.(\d{4})$/);
  if (!m) return false;

  const day   = parseInt(m[1], 10);
  const month = parseInt(m[2], 10) - 1;
  const year  = parseInt(m[3], 10);

  const d = new Date(year, month, day);
  if (d.getFullYear() !== year || d.getMonth() !== month || d.getDate() !== day) return false;
  if (d > new Date()) return false;
  return true;
}

/* ===== Helpers ===== */
const weekdays = ["Sonntag","Montag","Dienstag","Mittwoch","Donnerstag","Freitag","Samstag"];
const MS_DAY = 24*60*60*1000;

const addDays = (d,n) => { const x=new Date(d); x.setDate(x.getDate()+n); return x; };
const fmt = d => d.toLocaleDateString("de-DE");

/* ===== NRW Feiertage ===== */
function easterSunday(y){
  const f=Math.floor;
  const G=y%19, C=f(y/100);
  const H=(C-f(C/4)-f((8*C+13)/25)+19*G+15)%30;
  const I=H-f(H/28)*(1-f(29/(H+1))*f((21-G)/11));
  const J=(y+f(y/4)+I+2-C+f(C/4))%7;
  const L=I-J;
  return new Date(y,2,28+L); // March = 2
}

function getNRWHolidays(year){
  const e = easterSunday(year);
  // NRW: Neujahr, 1. Mai, 3. Okt, 25/26. Dez + Karfreitag, Ostermontag,
  // Christi Himmelfahrt, Pfingstmontag, Fronleichnam
  return [
    new Date(year,0,1),
    new Date(year,4,1),
    new Date(year,9,3),
    new Date(year,11,25),
    new Date(year,11,26),
    addDays(e,-2),
    addDays(e,1),
    addDays(e,39),
    addDays(e,50),
    addDays(e,60)
  ].map(d => d.toISOString().slice(0,10));
}

function isNRWHoliday(date){
  return getNRWHolidays(date.getFullYear()).includes(date.toISOString().slice(0,10));
}

function isWeekend(date){
  const wd = date.getDay();
  return wd === 0 || wd === 6;
}

function isWorkday(date){
  return !isWeekend(date) && !isNRWHoliday(date);
}

function subtractWorkdays(date, n){
  const x = new Date(date);
  while(n > 0){
    x.setDate(x.getDate() - 1);
    if (isWorkday(x)) n--;
  }
  return x;
}

/* ===== Planung ===== */
function buildCycles(startDate, schema){
  const cycles = [];  
  for (let c = 0; c < schema.anzahl_zyklen; c++){
    const cycleStart = addDays(startDate, c * schema.zyklus_tage);
    const nextCycleStart = addDays(cycleStart, schema.zyklus_tage);

    const days = Array.from({length: schema.zyklus_tage}, (_,i)=>({
      day: i+1,
      date: addDays(cycleStart, i),
      events: [],
      warnings: []
    }));

    // Events auf Tage mappen
    for (const ev of schema.events){
      let dayIndex = null;

      if (typeof ev.day === "number") {
        dayIndex = ev.day; // 1..zyklus_tage
      }

      if (typeof ev.workdays_before_next_cycle_start === "number") {
        const target = subtractWorkdays(nextCycleStart, ev.workdays_before_next_cycle_start);
        dayIndex = Math.round((target - cycleStart) / MS_DAY) + 1;
      }

      if (dayIndex && dayIndex >= 1 && dayIndex <= schema.zyklus_tage){
        days[dayIndex-1].events.push(ev);
      }
    }

    // Warnungen pro Tag (Feiertag / Wochenende)
    for (const d of days){
      if (isNRWHoliday(d.date)) d.warnings.push("‚ö†Ô∏è Feiertag");
      if (isWeekend(d.date)) d.warnings.push("‚ö†Ô∏è Wochenende");
    }

    cycles.push({ index: c+1, cycleStart, nextCycleStart, days });
  }

  return cycles;
}

/* ===== Rendering ===== */
function renderGraphicOneCycle(cycle){
  // Header (nur Wochentage)
  let header = `<div class="weekday-header">`;
  cycle.days.slice(0,7).forEach(d=>{
    header += `<div>${weekdays[d.date.getDay()]}</div>`;
  });
  header += `</div>`;

  // Grid (14 Tage = 2 Wochen √† 7)
  let grid = `<div class="grid">`;
  cycle.days.forEach(d=>{
    const weekendCls = isWeekend(d.date) ? "weekend" : "";
    const holidayCls = isNRWHoliday(d.date) ? "holiday" : "";
    grid += `<div class="day ${weekendCls} ${holidayCls}">`;

    const therapies = d.events.filter(ev => ev.type === "therapy");
    if (therapies.length > 0){
      grid += `<div class="therapy-bars">`;
      therapies.forEach(t => {
        const label = t.short || t.label || "";
        grid += `
          <div class="bar" style="background:${t.color || "#6b7280"}">
            ${label}
          </div>`;
      });
      grid += `</div>`;
    }

    d.events.forEach(ev=>{
      if (ev.type === "injection"){
        grid += `
          <div class="icon-block">
            <div class="icon">üíâ</div>
            <div class="icon-label">${ev.label}</div>
          </div>`;
      } else if (ev.type === "lab"){
        grid += `
          <div class="icon-block">
            <div class="icon">ü©∏</div>
            <div class="icon-label">${ev.label}</div>
          </div>`;
      }
    });

    // d1/d8 label unten rechts
    if (d.day === 1 || d.day === 8){
      grid += `<div class="day-label">d${d.day}</div>`;
    }

    grid += `</div>`;
  });
  grid += `</div>`;

  graphicEl.innerHTML = header + grid;
}

function renderTableAllCycles(cycles){
  let html = `
    <table>
      <tr>
        <th>Zyklus</th>
        <th>Datum</th>
        <th>Tag</th>
        <th>Ma√ünahme</th>
        <th>Hinweis</th>
      </tr>`;

  for (const cyc of cycles){
    for (const d of cyc.days){
      for (const ev of d.events){
        const hints = [];

        // Start der Therapie (d1) muss Werktag sein ‚Üí sonst h√§tten wir vorher schon abgebrochen.
        // Trotzdem: Markierungen f√ºr Wochenende/Feiertag:
        if (isNRWHoliday(d.date)) hints.push("‚ö†Ô∏è Feiertag");
        if (isWeekend(d.date)) hints.push("‚ö†Ô∏è Wochenende");

        html += `
          <tr>
            <td>${cyc.index}</td>
            <td>${fmt(d.date)}</td>
            <td>d${d.day}</td>
            <td>${ev.label}</td>
            <td class="warning">${hints.join(", ")}</td>
          </tr>`;
      }
    }
  }

  html += `</table>`;
  tableEl.innerHTML = html;
}

/* ===== Submit ===== */
formEl.addEventListener("submit", (e)=>{
  e.preventDefault();

  const geburt = geburtEl.value.trim();
  if (!isValidBirthdate(geburt)){
    alert("Bitte ein g√ºltiges Geburtsdatum im Format TT.MM.JJJJ eingeben.");
    geburtEl.focus();
    return;
  }

  const startDate = new Date(startEl.value);

  // Sicherstellen: Start darf nicht auf Wochenende/Feiertag liegen
  if (!isWorkday(startDate)){
    const reason = isNRWHoliday(startDate) ? "Feiertag (NRW)" : "Wochenende";
    alert(`Therapiestart (Zyklus 1, d1) darf nicht auf ${reason} fallen. Bitte Startdatum anpassen.`);
    startEl.focus();
    return;
  }

    const schemaKey = schemaSelect.value;
    const schema = schemas[schemaKey];

    const cycles = buildCycles(startDate, schema);
  // Patientenkopf
  patientEl.innerHTML = `
    <p>
      <strong>Patient:</strong> ${vornameEl.value} ${nachnameEl.value}<br>
      <strong>Geburtsdatum:</strong> ${geburt || "‚Äî"}
    </p>`;

  // Grafik: nur Zyklus 1
  renderGraphicOneCycle(cycles[0]);

  // Tabelle: alle Zyklen
  renderTableAllCycles(cycles);

  planEl.style.display = "block";
  document.getElementById("title").textContent = `Therapieplan ‚Äì ${schema.label}`;
});
</script>

</body>
</html>