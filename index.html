<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Therapieplan ‚Äì Onkologie</title>

<style>
  * {
    box-sizing: border-box;
  }
  :root {
    --primary: #2563eb;          /* Hauptblau */
    --primary-dark: #1e40af;     /* dunkler f√ºr Hover */
    --primary-light: #dbeafe;    /* helles Blau */
    --table-stripe: #f1f5f9;     /* sehr dezentes Grau-Blau */
    --text-dark: #1f2937;
  }
  body { font-family: system-ui, sans-serif; background:#f3f4f6; padding:2rem; }
  .container { max-width:1100px; margin:auto; }

  form, .plan {
    background:#fff; padding:1.5rem; border-radius:12px; margin-bottom:2rem;
    box-shadow:0 10px 25px rgba(0,0,0,0.08);
  }
  /* Formular als sauberes Grid */
  form {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 1.4rem 1.8rem;
    align-items: start;
  }

  /* Label als Block */
  form label {
    display: block;
    font-size: 0.8rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: #6b7280;
  }

  /* Inputs */
  form input,
  form select {
    display: block;
    width: 100%;
    margin-top: 0.5rem;
    padding: 0.75rem;
    border-radius: 10px;
    border: 1px solid #d1d5db;
    font-size: 0.95rem;
    background: #fff;
    transition: all 0.2s ease;
  }

  form input:focus,
  form select:focus {
    outline: none;
    border-color: #2563eb;
    box-shadow: 0 0 0 3px rgba(37,99,235,0.15);
  }

  /* Button volle Breite */
  form button {
    grid-column: 1 / -1;
    margin-top: 1rem;
    padding: 1rem;
    font-size: 1.05rem;
    border-radius: 12px;
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    transition: transform 0.15s ease, box-shadow 0.15s ease;
  }

  form button:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 22px rgba(0,0,0,0.15);
  }


  label { font-weight:600; font-size:0.85rem; display:block; }
  input, button { width:100%; padding:0.6rem; margin-top:0.25rem; }
  button {
    background:#2563eb; color:#fff; border:none; border-radius:8px;
    font-weight:600; cursor:pointer;
  }
  .schema-field {
    grid-column: span 2;
  }

  .start-field {
    grid-column: span 1;
  }
  .warning { color:#2563eb; font-weight:600; }

  /* ===== Grafik-Styles ===== */
  .weekday-header{
    display:grid; grid-template-columns:repeat(7,1fr);
    text-align:center; font-weight:600; font-size:0.75rem;
    margin-bottom:6px; color:#374151;
  }
  .grid{ display:grid; grid-template-columns:repeat(7,1fr); gap:6px; }
  .day {
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    min-height: 110px;
    padding: 10px 5px; /* Etwas mehr vertikaler Platz */
    background: #f9fafb;
    position: relative;
    display: flex;
    /* Dies zentriert die Balken und Icons horizontal als Gruppe */
    justify-content: center; 
    align-items: stretch;
    gap: 12px; /* Abstand zwischen Balken und Icons */
  }

  .day.weekend{ background:#e5e7eb; }
  .day.holiday{ outline:2px solid #2563eb; outline-offset:-2px; }
  
  .therapy-bars {
    display: flex;
    gap: 5px;
    flex-shrink: 0;
    /* Kein festes 'width' mehr, damit es sich zentriert */
  }

  .bar {
    width: 30px; /* Hier die Breite der Balken einstellen - jetzt breiter */
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 800; /* Noch etwas fetter f√ºr bessere Lesbarkeit */
    color: #fff;
    font-size: 0.7rem;
    box-shadow: inset 0 0 4px rgba(0,0,0,0.15);
    /* Schreibt den Buchstaben vertikal, falls er zu breit f√ºr 15px ist */
    writing-mode: vertical-rl; 
    text-orientation: upright;
    padding: 4px 0;
  }

  .day-content {
    /* Kein 'flex: 1' mehr, damit die Gruppe in der Mitte bleibt */
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
  }

  .icon-block {
    text-align: center;
  }

  .icon {
    font-size: 2.2rem;
    line-height: 1;
    margin-bottom: 2px;
  }

  .icon-label {
    font-size: 0.65rem;
    font-weight: 700;
    color: #374151;
    white-space: nowrap;
  }

  .day-label {
    position: absolute;
    bottom: 4px;
    right: 6px;
    font-size: 0.7rem;
    font-weight: 800;
    color: #9ca3af;
  }

  .followup-separator td {
    text-align: center;
    font-weight: 700;
    padding: 1rem;
    background: #e0ecff;
    border-top: 2px solid var(--primary);
    border-bottom: 2px solid var(--primary);
  }
  .legend { display:flex; flex-wrap:wrap; gap:16px; font-size:0.8rem; margin-top: 1rem; }
  .legend-item { display:flex; align-items:center; gap:8px; }
  .legend-bar { width:18px; height:18px; border-radius:4px; }

  table {
    width: 100%;
    border-collapse: separate; /* wichtig f√ºr runde Ecken */
    border-spacing: 0;
    margin-top: 1.5rem;
    font-size: 0.9rem;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 4px 14px rgba(0,0,0,0.06);
  }

  /* Header */
  th {
    background: var(--primary);
    color: white;
    padding: 0.75rem;
    text-transform: uppercase;
    font-size: 0.75rem;
    letter-spacing: 0.6px;
    text-align: left;
  }

  /* Runde obere Ecken */
  th:first-child { border-top-left-radius: 12px; }
  th:last-child  { border-top-right-radius: 12px; }

  /* Zellen */
  td {
    padding: 0.7rem 0.8rem;
    color: var(--text-dark);
  }

  /* Zebra-Streifen */
  tbody tr:nth-child(even) {
    background: var(--table-stripe);
  }

  /* Hover dezenter */
  tbody tr:hover {
    background: var(--primary-light);
  }

  /* Letzte Zeile abrunden */
  tbody tr:last-child td:first-child {
    border-bottom-left-radius: 12px;
  }
  tbody tr:last-child td:last-child {
    border-bottom-right-radius: 12px;
  }

  .warning {
    font-weight: 600;
    color: #b91c1c;
  }
  .schema-info {
    margin-top: 12px;
    font-size: 0.9rem;
    color: #374151;
    padding-top: 8px;
    border-top: 1px solid #e5e7eb;
  }


    /* Date-Input optisch an andere Felder angleichen */
    form input[type="date"] {
      height: auto;
      line-height: 1.2;
      padding: 0.75rem;
    }
    form input[type="date"]::-webkit-date-and-time-value {
      text-align: left;
    }

  /* ===== DRUCK-LOGIK ===== */
  @media print {

  form,
  .no-print,
  h1#title {
    display: none !important;
  }

  body {
    background: #fff;
    margin: 0;
    padding: 0;
  }

  .container {
    max-width: 100%;
    margin: 0;
  }

  .plan {
    box-shadow: none;
    border: none;
    padding: 0;
  }

  /* Standard: alles verstecken */
  #graphic,
  #legend,
  #table,
  #print-footer,
  #supportPlan {
    display: none;
  }

  /* ===== Grafikdruck ===== */
  body.print-graphic #graphic,
  body.print-graphic #legend,
  body.print-graphic #patient,
  body.print-graphic #print-footer {
    display: block !important;
  }

  body.print-graphic {
    page: graphicPage;
  }

  body.print-support #supportPlan,
  body.print-support #patient,
  body.print-support #print-footer {
    display: block !important;
  }

  body.print-support {
    page: supportPage;
  }

  @page supportPage {
    size: A4 portrait;
    margin: 15mm;
  }

  @page graphicPage {
    size: A4 landscape;
    margin: 10mm;
  }

  /* ===== Tabellendruck ===== */
  body.print-table #table,
  body.print-table #patient,
  body.print-table #print-footer {
    display: block !important;
    font-size: 0.8rem;   /* vorher ~0.9rem */

  }

  body.print-table {
    page: tablePage;
  }

  body.print-table th,
  body.print-table td {
    font-size: 0.8rem;
    padding: 4px 6px;    /* etwas kompakter */
  }

  @page tablePage {
    size: A4 portrait;
    margin: 15mm;
  }

  thead {
    display: table-header-group;
  }

  tr {
    page-break-inside: avoid;
  }

  * {
    -webkit-print-color-adjust: exact !important;
    print-color-adjust: exact !important;
  }
}
</style>
</head>

<body>
<div class="container">
  <h1 id="title">Therapieplan Erstellung</h1>

  <form id="therapyForm">
    <label>Vorname<input id="vorname" required></label>
    <label>Nachname<input id="nachname" required></label>
    <label>Geburtsdatum (optional, TT.MM.JJJJ)
      <input id="geburt" placeholder="TT.MM.JJJJ">
    </label>
    <label class="schema-field">
      Chemotherapie-Schema
      <input list="schemaList" id="schemaInput" required>
      <datalist id="schemaList"></datalist>
    </label>

    <label class="start-field">
      Startdatum Zyklus 1
      <input type="date" id="startdatum" required>
    </label>
    <label style="grid-column: 1 / -1;">
      Begleitmedikation ausw√§hlen:
      <select id="supportSelect"></select>
    </label>

    <label style="grid-column: 1 / -1;">    
      <input type="checkbox" id="hasFollowUp">
      Anschlusstherapie?
    </label>

    <label id="followUpWrapper" style="display:none; grid-column: 1 / -1;">
      Folgetherapie ausw√§hlen:
      <select id="followUpSelect"></select>
    </label>

    <label id="supportFollowUpWrapper" style="display:none; grid-column: 1 / -1;">
      Begleitmedikation Folgetherapie:
      <select id="supportFollowUpSelect"></select>
    </label>
    <button type="submit">Plan berechnen</button>
  </form>

  <div class="plan" id="plan" style="display:none">
    <div id="patient"></div>
    
    <div id="graphic-container">
        <h2 class="no-print">Grafische √úbersicht (1 Zyklus)</h2>
        <div id="graphic"></div>
    </div>

    <div class="no-print" style="margin:2rem 0; display:flex; gap:1rem; background: #eee; padding: 1rem; border-radius: 8px;">
        <button type="button" onclick="printGraphic()">Grafik drucken (Querformat)</button>
        <button type="button" onclick="printTable()">Tabelle drucken (Hochformat)</button>
        <button type="button" onclick="printSupport()">Begleitmedikation drucken</button>
    </div>

    <div id="table-container">
        <h2 class="no-print">Tabellarische √úbersicht (alle Zyklen)</h2>
        <div id="table"></div>
        <div id="supportGraphic"></div>
        <div id="supportPlan"></div>
    </div>
    <div id="print-footer" class="print-footer">
      <hr>
      <p>
        Telefonnummer GynOnko Ambulanz: 0241/6006-1685<br>
        24/7 Notfall-Rufnummer: 0241/6006-0 (mit diensthabender Gyn√§kologin verbinden lassen)
      </p>
    </div>
  </div>
</div>

<script type="application/json" id="schemas">
{
  "EC_q2w": {
    "label": "EC q2w",
    "zyklus_tage": 14,
    "anzahl_zyklen": 4,
    "events": [
      { "type": "therapy", "drug": "Epirubicin", "short": "E", "color": "#2563eb", "day": 1 },
      { "type": "therapy", "drug": "Cyclophosphamid", "short": "C", "color": "#b91c1c", "day": 1 },
      { "type": "injection", "label": "Pegfilgrastim", "day": 2 },
      { "type": "lab", "label": "Labor", "day": 8 },
      { "type": "lab", "label": "Labor", "workdays_before_next_cycle_start": 2 }
    ]
  },
  "EC_q3w": {
    "label": "EC q3w",
    "zyklus_tage": 21,
    "anzahl_zyklen": 4,
    "events": [
      { "type": "therapy", "drug": "Epirubicin", "short": "E", "color": "#2563eb", "day": 1 },
      { "type": "therapy", "drug": "Cyclophosphamid", "short": "C", "color": "#b91c1c", "day": 1 },
      { "type": "lab", "label": "Labor", "day": 8 },
      { "type": "lab", "label": "Labor", "workdays_before_next_cycle_start": 2 }
    ]
  },
  "Paclitaxel_qw": {
    "label": "Paclitaxel w√∂chentlich",
    "zyklus_tage": 7,
    "anzahl_zyklen": 12,
    "events": [
      { "type": "therapy", "drug": "Paclitaxel", "short": "Pac", "color": "#059669", "day": 1 },
      { "type": "lab", "label": "Labor", "workdays_before_next_cycle_start": 2 }
    ]
  },
  "Paclitaxel_Pembro_q3w": {
    "label": "Paclitaxel qw, Pembrolizumab q3w",
    "zyklus_tage": 21,
    "anzahl_zyklen": 4,
    "events": [
      { "type": "therapy", "drug": "Paclitaxel", "short": "Pac", "color": "#059669", "day": 1 },    
      { "type": "therapy", "drug": "Pembrolizumab", "short": "Pem", "color": "#8b5cf6", "day": 1 },      
      { "type": "therapy", "drug": "Paclitaxel", "short": "Pac", "color": "#059669", "day": 8 },
      { "type": "therapy", "drug": "Paclitaxel", "short": "Pac", "color": "#059669", "day": 15 },         
      { "type": "lab", "label": "Labor", "workdays_before_next_cycle_start": 2 },
      { "type": "lab", "label": "Labor", "workdays_before_next_cycle_start": 7 },
      { "type": "lab", "label": "Labor", "workdays_before_next_cycle_start": 12 }
    ]
  },
  "EC_Pembro_q3w": {
    "label": "EC-Pembrolizumab q3w",
    "zyklus_tage": 21,
    "anzahl_zyklen": 4,
    "events": [
      { "type": "therapy", "drug": "Epirubicin", "short": "E", "color": "#2563eb", "day": 1 },
      { "type": "therapy", "drug": "Cyclophosphamid", "short": "C", "color": "#b91c1c", "day": 1 },
      { "type": "therapy", "drug": "Pembrolizumab", "short": "Pem", "color": "#8b5cf6", "day": 1 },      
      { "type": "lab", "label": "Labor", "day": 8 },
      { "type": "lab", "label": "Labor", "workdays_before_next_cycle_start": 2 }
    ]
  },
  "TCbHP_q3w": {
    "label": "TCbHP: Docetaxel, Carboplatin, Trastuzumab, Pertuzumab q3w",
    "zyklus_tage": 21,
    "anzahl_zyklen": 6,
    "events": [
      { "type": "therapy", "drug": "Docetaxel", "short": "T", "color": "#059669", "day": 1 },    
      { "type": "therapy", "drug": "Carboplatin", "short": "Cb", "color": "#f59e0b", "day": 1 },      
      { "type": "therapy", "drug": "Trastuzumab", "short": "Her", "color": "#7c3aed", "day": 1 },
      { "type": "therapy", "drug": "Pertuzumab", "short": "Per", "color": "#c026d3", "day": 1 },     
      { "type": "injection", "label": "Pegfilgrastim", "day": 3 },    
      { "type": "lab", "label": "Labor", "workdays_before_next_cycle_start": 2 },
      { "type": "lab", "label": "Labor", "day": 8 }
    ]
  },
  "Paclitaxel_Tratuzumab_Pertuzumab_q3w": {
    "label": "Paclitaxel w√∂chentlich, Trastuzumab/Pertuzumab alle 3 Wochen",
    "zyklus_tage": 21,
    "anzahl_zyklen": 4,
    "events": [
      { "type": "therapy", "drug": "Paclitaxel", "short": "Pac", "color": "#059669", "day": 1 },    
      { "type": "therapy", "drug": "Trastuzumab", "short": "Her", "color": "#7c3aed", "day": 1 },
      { "type": "therapy", "drug": "Pertuzumab", "short": "Per", "color": "#c026d3", "day": 1 },  
      { "type": "therapy", "drug": "Paclitaxel", "short": "Pac", "color": "#059669", "day": 8 },
      { "type": "therapy", "drug": "Paclitaxel", "short": "Pac", "color": "#059669", "day": 15 },         
      { "type": "lab", "label": "Labor", "workdays_before_next_cycle_start": 2 },
      { "type": "lab", "label": "Labor", "workdays_before_next_cycle_start": 7 },
      { "type": "lab", "label": "Labor", "workdays_before_next_cycle_start": 12 }
    ]
  },
  "APT": {
    "label": "APT (Paclitaxel, Trastuzumab qw)",
    "zyklus_tage": 7,
    "anzahl_zyklen": 12,
    "events": [
      { "type": "therapy", "drug": "Paclitaxel", "short": "Pac", "color": "#059669", "day": 1 },
      { "type": "therapy", "drug": "Trastuzumab", "short": "Her", "color": "#7c3aed", "day": 1 },
      { "type": "lab", "label": "Labor", "workdays_before_next_cycle_start": 2 }
    ]
  }
}
</script>

<script>
const schemas = JSON.parse(document.getElementById("schemas").textContent);
const schemaInput = document.getElementById("schemaInput");
const schemaList = document.getElementById("schemaList");

const supportEl = document.getElementById("supportPlan");
const supportGraphicEl = document.getElementById("supportGraphic");
const supportSelect = document.getElementById("supportSelect");
const supportFollowUpSelect = document.getElementById("supportFollowUpSelect");
const supportFollowUpWrapper = document.getElementById("supportFollowUpWrapper");

const supportSchemas = {
  "None": {
    label: "Keine Begleitmedikation",
    version: "‚Äì",
    days: []
  },
  "Akynzeo_Olanzapin": {
    label: "Akynzeo ‚Äì Olanzapin",
    version: "v1.0 ‚Äì 01/2026",
    days: [
      { day: 1, meds: [
        { name: "Akynzeo 300/0,5 mg", dosage: "1-0-0", note: "morgens" },
        { name: "Olanzapin 5 mg", dosage: "1-0-0", note: "morgens" }
      ]},
      { day: 2, meds: [
        { name: "Olanzapin 5 mg", dosage: "0-0-1", note: "abends" }
      ]},
      { day: 3, meds: [
        { name: "Olanzapin 5 mg", dosage: "0-0-1", note: "abends" }
      ]},
      { day: 4, meds: [
        { name: "Olanzapin 5 mg", dosage: "0-0-1", note: "abends" }
      ]}
    ]
  }
};

Object.entries(schemas).forEach(([key, schema]) => {
  const option = document.createElement("option");
  option.value = schema.label;   // was der Nutzer sieht
  option.dataset.key = key;      // interner Schl√ºssel
  schemaList.appendChild(option);
});

Object.entries(supportSchemas).forEach(([key, schema]) => {
  const opt = document.createElement("option");
  opt.value = key;
  opt.textContent = schema.label;
  supportSelect.appendChild(opt);

  const opt2 = document.createElement("option");
  opt2.value = key;
  opt2.textContent = schema.label;
  supportFollowUpSelect.appendChild(opt2);
});

const hasFollowUpEl = document.getElementById("hasFollowUp");
const followUpWrapper = document.getElementById("followUpWrapper");
const followUpSelect = document.getElementById("followUpSelect");
function updateFollowUpVisibility() {
  const show = hasFollowUpEl.checked;
  followUpWrapper.style.display = show ? "block" : "none";
  supportFollowUpWrapper.style.display = show ? "block" : "none";
}

hasFollowUpEl.addEventListener("change", updateFollowUpVisibility);

// Initial einmal ausf√ºhren
updateFollowUpVisibility();

Object.entries(schemas).forEach(([key, schema]) => {
  const opt = document.createElement("option");
  opt.value = key;
  opt.textContent = schema.label;
  followUpSelect.appendChild(opt);
});



const formEl = document.getElementById("therapyForm");
const vornameEl = document.getElementById("vorname");
const nachnameEl = document.getElementById("nachname");
const geburtEl = document.getElementById("geburt");
const startEl = document.getElementById("startdatum");
const planEl = document.getElementById("plan");
const graphicEl = document.getElementById("graphic");
const patientEl = document.getElementById("patient");
const tableEl = document.getElementById("table");

const weekdays = ["Sonntag","Montag","Dienstag","Mittwoch","Donnerstag","Freitag","Samstag"];
const MS_DAY = 24*60*60*1000;
const addDays = (d,n) => { const x=new Date(d); x.setDate(x.getDate()+n); return x; };
const fmt = d => d.toLocaleDateString("de-DE");

function isValidBirthdate(value){
  if (!value) return true;
  const m = value.match(/^(\d{2})\.(\d{2})\.(\d{4})$/);
  if (!m) return false;
  const d = new Date(parseInt(m[3],10), parseInt(m[2],10)-1, parseInt(m[1],10));
  return d instanceof Date && !isNaN(d) && d <= new Date();
}

function easterSunday(y){
  const f=Math.floor, G=y%19, C=f(y/100);
  const H=(C-f(C/4)-f((8*C+13)/25)+19*G+15)%30;
  const I=H-f(H/28)*(1-f(29/(H+1))*f((21-G)/11));
  const J=(y+f(y/4)+I+2-C+f(C/4))%7;
  const L=I-J;
  return new Date(y,2,28+L);
}

function getNRWHolidays(year){
  const e = easterSunday(year);
  return [
    new Date(year,0,1), new Date(year,4,1), new Date(year,9,3), new Date(year,11,25), new Date(year,11,26),
    addDays(e,-2), addDays(e,1), addDays(e,39), addDays(e,50), addDays(e,60)
  ].map(d => d.toISOString().slice(0,10));
}

function isNRWHoliday(date){ return getNRWHolidays(date.getFullYear()).includes(date.toISOString().slice(0,10)); }
function isWeekend(date){ return date.getDay() === 0 || date.getDay() === 6; }
function isWorkday(date){ return !isWeekend(date) && !isNRWHoliday(date); }

function subtractWorkdays(date, n){
  const x = new Date(date);
  while(n > 0){ x.setDate(x.getDate() - 1); if (isWorkday(x)) n--; }
  return x;
}

function buildCycles(startDate, schema, omitLastWorkdayLab=false){
  const cycles = [];

  for (let c = 0; c < schema.anzahl_zyklen; c++){
    const cycleStart = addDays(startDate, c * schema.zyklus_tage);
    const nextCycleStart = addDays(cycleStart, schema.zyklus_tage);

    const days = Array.from({length: schema.zyklus_tage}, (_,i)=>({
      day: i+1,
      date: addDays(cycleStart, i),
      events: []
    }));

    for (const ev of schema.events){

      // Falls letzter Zyklus und keine Anschlusstherapie ‚Üí letzte Labor weglassen
      if (
        omitLastWorkdayLab &&
        c === schema.anzahl_zyklen - 1 &&
        ev.workdays_before_next_cycle_start
      ) continue;

      let dIdx = null;

      if (typeof ev.day === "number")
        dIdx = ev.day;

      if (typeof ev.workdays_before_next_cycle_start === "number") {
        const target = subtractWorkdays(nextCycleStart, ev.workdays_before_next_cycle_start);
        dIdx = Math.round((target - cycleStart) / MS_DAY) + 1;
      }

      if (dIdx && dIdx >= 1 && dIdx <= schema.zyklus_tage)
        days[dIdx-1].events.push(ev);
    }

    cycles.push({ index: c+1, days });
  }

  return cycles;
}

function renderLegend(schema){
  const items = [];
  const therapies = schema.events.filter(e => e.type === "therapy");

  const uniqueTherapies = {};
  therapies.forEach(t => uniqueTherapies[t.short || t.drug] = t);

  Object.values(uniqueTherapies).forEach(t => {
    items.push(`
      <div class="legend-item">
        <div class="legend-bar" style="background:${t.color}"></div>
        <span>${t.drug}</span>
      </div>
    `);
  });

  if (schema.events.some(e => e.type === "injection"))
    items.push(`<div class="legend-item"><span>üíâ</span><span>Pegfilgrastim</span></div>`);

  if (schema.events.some(e => e.type === "lab"))
    items.push(`<div class="legend-item"><span>ü©∏</span><span>Labor</span></div>`);

  const infoText = `
    <div class="schema-info">
      Dieses Behandlungsschema umfasst 
      <strong>${schema.zyklus_tage} Tage pro Zyklus</strong> 
      und wird insgesamt √ºber 
      <strong>${schema.anzahl_zyklen} Zyklen</strong> 
      durchgef√ºhrt.
    </div>
  `;

  return `<div class="legend">${items.join("")}</div>${infoText}`;
}

function renderGraphicOneCycle(cycle, targetEl){
  let html = `<div class="weekday-header">` +
    cycle.days.slice(0,7)
      .map(d => `<div>${weekdays[d.date.getDay()]}</div>`)
      .join("") +
    `</div>`;

  html += `<div class="grid">` + cycle.days.map(d => {

    const cls = (isWeekend(d.date) ? "weekend " : "") +
                (isNRWHoliday(d.date) ? "holiday" : "");

    const therapies = d.events.filter(ev => ev.type === "therapy");

    let barHtml = "";
    if (therapies.length > 0) {
      barHtml = `<div class="therapy-bars">` +
        therapies.map(t =>
          `<div class="bar" style="background:${t.color}">${t.short}</div>`
        ).join("") +
      `</div>`;
    }

    let iconsHtml = "";
    d.events.forEach(ev => {
      if(ev.type === "injection")
        iconsHtml += `<div class="icon-block"><div class="icon">üíâ</div><div class="icon-label">${ev.label}</div></div>`;
      if(ev.type === "lab")
        iconsHtml += `<div class="icon-block"><div class="icon">ü©∏</div><div class="icon-label">${ev.label}</div></div>`;
    });

    const dayLabel = ((d.day - 1) % 7 === 0)
      ? `<div class="day-label">d${d.day}</div>`
      : "";

    return `
      <div class="day ${cls}">
        ${barHtml}
        <div class="day-content">
          ${iconsHtml}
          ${dayLabel}
        </div>
      </div>`;
  }).join("") + `</div>`;

  targetEl.innerHTML = html;
}

function renderTableAllCycles(cycles, followUpLabel = null, mainCycleCount = null){

  let html = `
    <table>
      <thead>
        <tr>
          <th>Datum</th>
          <th>Zyklus</th>
          <th>Tag</th>
          <th>Ma√ünahme</th>
          <th>Hinweis</th>
        </tr>
      </thead>
      <tbody>
  `;

  cycles.forEach((cyc, index) => {

    cyc.days.forEach(d => {

      if (d.events.length === 0) return;

      const measures = d.events.map(ev => ev.drug || ev.label).join(", ");

      let hint = "";
      if (isNRWHoliday(d.date)) hint = "‚ö†Ô∏è Feiertag";
      else if (isWeekend(d.date)) hint = "‚ö†Ô∏è Wochenende";

      html += `
        <tr>
          <td>${fmt(d.date)}</td>
          <td>${cyc.index}</td>
          <td>d${d.day}</td>
          <td>${measures}</td>
          <td class="warning">${hint}</td>
        </tr>`;
    });

    // üîµ NACH letzter Haupttherapie-Zyklus ‚Üí Trennzeile einf√ºgen
    if (
      followUpLabel &&
      mainCycleCount &&
      index === mainCycleCount - 1
    ) {
      html += `
        <tr class="followup-separator">
          <td colspan="5">
            Umstellung auf Folgetherapie: ${followUpLabel}
          </td>
        </tr>
      `;
    }

  });

  html += `
      </tbody>
    </table>`;

  tableEl.innerHTML = html;
}

function renderSupportPlan(
  cycles,
  mainSupportSchema,
  titleText,
  mainLabel,
  mainCycleCount = null,
  followLabel = null,
  followSupportSchema = null
) {
  let graphicHtml = "";

  // Patch: Provide idx to forEach and use idx for follow-up label logic
  cycles.forEach((cycle, idx) => {
    let currentLabel = mainLabel;

    if (mainCycleCount && followLabel && idx >= mainCycleCount) {
      currentLabel = followLabel;
    }

    // W√§hle korrektes Begleitmedikationsschema (Haupt- oder Folgetherapie)
    let currentSupportSchema = mainSupportSchema;
    if (mainCycleCount && followSupportSchema && idx >= mainCycleCount) {
      currentSupportSchema = followSupportSchema;
    }

    graphicHtml += `
      <div style="margin-top:2rem;">
        <h2>Zyklus ${cycle.index} ${currentLabel}:</h2>
      </div>
    `;

    const totalDays = cycle.days.length;

    // Welche Wochen enthalten Begleitmedikation?
    const weeksToRender = new Set();
    currentSupportSchema.days.forEach(supportDay => {
      const weekIndex = Math.floor((supportDay.day - 1) / 7);
      weeksToRender.add(weekIndex);
    });

    const sortedWeeks = Array.from(weeksToRender).sort((a, b) => a - b);

    sortedWeeks.forEach(w => {
      graphicHtml += `
        <div style="
          display:grid;
          grid-template-columns:repeat(7,1fr);
          gap:10px;
          margin-bottom:1.5rem;
        ">
      `;

      for (let i = 0; i < 7; i++) {
        const dayIndex = w * 7 + i;
        if (dayIndex >= totalDays) break;

        const dayObj = cycle.days[dayIndex];
        const date = dayObj.date;
        const weekday = weekdays[date.getDay()];
        const supportDay = currentSupportSchema.days.find(d => d.day === dayObj.day);

        const isWeekendDay = isWeekend(date);
        const isHolidayDay = isNRWHoliday(date);

        let warningIcon = "";
        if (isHolidayDay) warningIcon = " ‚ö†Ô∏è Feiertag";
        else if (isWeekendDay) warningIcon = " ‚ö†Ô∏è Wochenende";

        graphicHtml += `
          <div style="
            border:1px solid #e5e7eb;
            border-radius:12px;
            padding:10px;
            background:${isWeekendDay || isHolidayDay ? '#f3f4f6' : '#f9fafb'};
            min-height:120px;
          ">
            <div style="font-weight:700; margin-bottom:6px; font-size:1.1rem;">
              ${fmt(date)}<br>
              <span style="font-weight:500; font-size:0.75rem; color:#6b7280;">
                ${weekday} (d${dayObj.day})
              </span>
              ${
                warningIcon
                  ? `<div style="font-size:0.75rem; color:#b91c1c; margin-top:4px;">
                       ${warningIcon}
                     </div>`
                  : ""
              }
            </div>
        `;

        if (supportDay) {
          supportDay.meds.forEach(med => {
            graphicHtml += `
              <div style="
                margin-bottom:6px;
                padding:6px;
                background:white;
                border-radius:8px;
                font-size:0.8rem;
                box-shadow:0 1px 3px rgba(0,0,0,0.05);
              ">
                <strong>${med.name}</strong><br>
                ${med.dosage}${med.note ? ' ‚Äì ' + med.note : ''}
              </div>
            `;
          });
        }

        graphicHtml += `</div>`;
      }

      graphicHtml += `</div>`;
    });
  });

  supportGraphicEl.innerHTML = graphicHtml;

  // /* ===== TABELLARISCHE √úBERSICHT ===== */

  // let html = `
  //   <div style="margin-top:2rem;">
  //     <h2>Begleitmedikationsplan ‚Äì ${schema.label}</h2>
  //     <p>
  //       <strong>Therapie:</strong> ${titleText}<br>
  //       <strong>Version:</strong> ${schema.version}
  //     </p>
  //   </div>

  //   <table>
  //     <thead>
  //       <tr>
  //         <th>Datum</th>
  //         <th>Wochentag</th>
  //         <th>Zyklus</th>
  //         <th>Medikation</th>
  //         <th>Dosierung</th>
  //         <th>Hinweis</th>
  //       </tr>
  //     </thead>
  //     <tbody>
  // `;

  // cycles.forEach(cycle => {
  //   cycle.days.forEach(dayObj => {
  //     const supportDay = schema.days.find(d => d.day === dayObj.day);
  //     if (!supportDay) return;

  //     const date = dayObj.date;
  //     const weekday = weekdays[date.getDay()];

  //     supportDay.meds.forEach(med => {
  //       html += `
  //         <tr>
  //           <td>${fmt(date)}</td>
  //           <td>${weekday}</td>
  //           <td>${cycle.index}</td>
  //           <td>${med.name}</td>
  //           <td>${med.dosage}</td>
  //           <td>${med.note || ''}</td>
  //         </tr>
  //       `;
  //     });
  //   });
  // });

  // html += `
  //     </tbody>
  //   </table>

  //   <div style="margin-top:1rem; font-size:0.9rem;">
  //     <strong>Notfallhinweis:</strong><br>
  //     Bei Fieber >38¬∞C, anhaltendem Erbrechen oder Unsicherheit bitte sofort melden.<br>
  //     GynOnko Ambulanz: 0241/6006-1685
  //   </div>
  // `;

  // supportEl.innerHTML = html;
}

/* ===== DRUCK-FUNKTIONEN ===== */
function printGraphic() {
  document.body.classList.remove("print-table");
  document.body.classList.add("print-graphic");
  setTimeout(() => window.print(), 50);
}

function printTable() {
  document.body.classList.remove("print-graphic");
  document.body.classList.add("print-table");
  setTimeout(() => window.print(), 50);
}

function printSupport() {
  document.body.classList.remove("print-graphic","print-table");
  document.body.classList.add("print-support");
  setTimeout(() => window.print(), 50);
}


formEl.addEventListener("submit", (e)=>{
  e.preventDefault();
  const geburt = geburtEl.value.trim();
  if (!isValidBirthdate(geburt)) { alert("Geburtsdatum pr√ºfen!"); return; }
  
  const startDate = new Date(startEl.value + 'T12:00:00');
  if (!isWorkday(startDate)){ alert("Startdatum muss ein Arbeitstag sein!"); return; }

  const selected = Object.entries(schemas).find(
    ([key, schema]) => schema.label.toLowerCase().includes(schemaInput.value.toLowerCase())
  );

  if (!selected) {
    alert("Bitte ein g√ºltiges Schema ausw√§hlen.");
    return;
  }

  const [schemaKey, schema] = selected;  

  const hasFollowUp = hasFollowUpEl.checked;

  let cyclesMain = buildCycles(startDate, schema, !hasFollowUp);
  let allCycles = [...cyclesMain];

  graphicEl.innerHTML = "";   // Wichtig: vorher leeren

  renderGraphicOneCycle(cyclesMain[0], graphicEl);
  const mainLegendHtml = renderLegend(schema);
  const mainLegendWrapper = document.createElement("div");
  mainLegendWrapper.innerHTML = mainLegendHtml;
  graphicEl.appendChild(mainLegendWrapper);
  if (hasFollowUp) {

    const followSchema = schemas[followUpSelect.value];
    const followStart = addDays(
        startDate,
        schema.zyklus_tage * schema.anzahl_zyklen
    );

    const cyclesFollow = buildCycles(followStart, followSchema, false);
    allCycles = [...cyclesMain, ...cyclesFollow];

    const secondWrapper = document.createElement("div");
    secondWrapper.innerHTML = `<h2 style="margin-top:2rem;">Folgetherapie: ${followSchema.label}</h2>`;

    const secondGraphic = document.createElement("div");

    secondWrapper.appendChild(secondGraphic);
    graphicEl.appendChild(secondWrapper);

    renderGraphicOneCycle(cyclesFollow[0], secondGraphic);
    const followLegendHtml = renderLegend(followSchema);
    const followLegendWrapper = document.createElement("div");
    followLegendWrapper.innerHTML = followLegendHtml;
    secondWrapper.appendChild(followLegendWrapper);
  }
  // Der Patientenkopf enth√§lt nun explizit das Schema als Titel

// Titel dynamisch zusammensetzen
let titleText = schema.label;

if (hasFollowUp) {
  const followSchema = schemas[followUpSelect.value];
  titleText += " ‚Üí " + followSchema.label;
}

// Patientenkopf
patientEl.innerHTML = `
  <div style="border-bottom: 2px solid #333; margin-bottom: 20px; padding-bottom: 10px;">
    <h1 style="margin:0 0 10px 0; color:#2563eb; font-size: 1.8rem;">
      Therapieplan: ${titleText}
    </h1>
    <p style="margin:0; font-size: 1.1rem; line-height: 1.5;">
      <strong>Patient:</strong> ${vornameEl.value} ${nachnameEl.value} | 
      <strong>Geburtsdatum:</strong> ${geburt || "‚Äî"}<br> 
      <strong>Datum erste Therapie:</strong> ${fmt(startDate)}<br>
      <span style="font-size: 0.9rem; color: #666;">
        Erstellt am: ${new Date().toLocaleDateString("de-DE")}
      </span>
    </p>
  </div>`;

  window.onafterprint = () => {
    document.body.classList.remove("print-graphic","print-table");
  };

  if (hasFollowUp) {
    renderTableAllCycles(
      allCycles,
      schemas[followUpSelect.value].label,
      cyclesMain.length
    );
  } else {
    renderTableAllCycles(allCycles);
  }
  supportEl.innerHTML = "";
  supportGraphicEl.innerHTML = "";

  const mainSupportSchema = supportSchemas[supportSelect.value] || null;
  const followSupportSchema = hasFollowUp
    ? supportSchemas[supportFollowUpSelect.value] || null
    : null;

  if (mainSupportSchema) {
    renderSupportPlan(
      allCycles,
      mainSupportSchema,
      titleText,
      schema.label,
      hasFollowUp ? cyclesMain.length : null,
      hasFollowUp ? schemas[followUpSelect.value].label : null,
      followSupportSchema
    );
  }

  planEl.style.display = "block";
  planEl.scrollIntoView({ behavior: 'smooth' });
});

</script>
</body>
</html>