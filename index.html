<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Therapieplan â€“ EC q2w</title>

<style>
  body {
    font-family: system-ui, sans-serif;
    background: #f3f4f6;
    padding: 2rem;
  }
  .container { max-width: 1000px; margin: auto; }

  form, .plan {
    background: white;
    padding: 1.5rem;
    border-radius: 12px;
    margin-bottom: 2rem;
    box-shadow: 0 10px 25px rgba(0,0,0,0.08);
  }

  label { font-weight: 600; font-size: 0.85rem; display:block; }
  input, button {
    width: 100%; padding: 0.6rem; margin-top: 0.25rem;
  }
  button {
    background: #dc2626; color: white;
    border: none; border-radius: 8px;
    font-weight: 600; cursor: pointer;
  }

  /* ===== Graphic Schedule ===== */
  .cycle-title {
    font-weight: 700;
    margin-bottom: 0.5rem;
  }

  .grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 6px;
  }

  .day {
    border: 1px solid #e5e7eb;
    border-radius: 6px;
    min-height: 60px;
    padding: 4px;
    font-size: 0.75rem;
    background: #f9fafb;
    position: relative;
  }

  .day-label {
    position: absolute;
    top: 4px;
    left: 6px;
    font-size: 0.65rem;
    font-weight: 600;
    color: #374151;
  }

  .therapy {
    background: #dc2626;
    color: white;
    border-radius: 4px;
    padding: 4px;
    font-weight: 600;
    font-size: 0.7rem;
    text-align: center;
    margin-top: 16px;
  }

  .icon {
    font-size: 1.2rem;
    text-align: center;
    margin-top: 18px;
  }

  /* ===== Table ===== */
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 1rem;
  }
  th, td {
    padding: 0.5rem;
    border-bottom: 1px solid #e5e7eb;
    text-align: left;
  }

  @media print {
    form, button { display: none; }
    body { background: white; }
  }
</style>
</head>

<body>
<div class="container">

<h1>Therapieplan EC q2w</h1>

<form id="therapyForm">
  <label>Vorname<input id="vorname" required></label>
  <label>Nachname<input id="nachname" required></label>
  <label>Geburtsdatum (optional)<input id="geburt" placeholder="TT.MM.JJJJ"></label>
  <label>Startdatum Zyklus 1<input type="date" id="startdatum" required></label>
  <button>Plan berechnen</button>
</form>

<div class="plan" id="plan" style="display:none">

  <h2>Grafische Ãœbersicht (ein Zyklus)</h2>
  <div id="graphic"></div>

  <h2 style="margin-top:2rem">Tabellarische Ãœbersicht (alle Zyklen)</h2>
  <div id="table"></div>

  <button onclick="window.print()">Drucken / PDF</button>
</div>

</div>

<!-- ===== Schema ===== -->
<script type="application/json" id="schema-EC-q2w">
{
  "name": "EC q2w",
  "zyklus_tage": 14,
  "anzahl_zyklen": 4,
  "events": [
    { "label": "EC", "type": "therapy", "day": 1 },
    { "label": "Pegfilgrastim", "type": "injection", "day": 2 },
    { "label": "Labor", "type": "lab", "day": 8 },
    { "label": "Labor", "type": "lab", "workdays_before_cycle_end": 2 }
  ]
}
</script>

<script>
/* ===== Helpers ===== */
const addDays=(d,n)=>{const x=new Date(d);x.setDate(x.getDate()+n);return x;}
const fmt=d=>d.toLocaleDateString("de-DE");

function subtractWorkdays(d,n){
  const x=new Date(d);
  while(n>0){
    x.setDate(x.getDate()-1);
    const w=x.getDay();
    if(w!==0 && w!==6) n--;
  }
  return x;
}

/* ===== Cycle Calculation ===== */
function calculateCycles(start,schema){
  const all=[];
  for(let c=0;c<schema.anzahl_zyklen;c++){
    const cs=addDays(start,c*schema.zyklus_tage);
    const ce=addDays(cs,schema.zyklus_tage-1);

    const days=[...Array(schema.zyklus_tage)].map((_,i)=>({
      day:i+1,
      date:addDays(cs,i),
      events:[]
    }));

    schema.events.forEach(e=>{
      let d;
      if(e.day) d=e.day;
      if(e.workdays_before_cycle_end){
        const date=subtractWorkdays(ce,e.workdays_before_cycle_end);
        d=Math.round((date-cs)/(1000*60*60*24))+1;
      }
      days[d-1].events.push(e);
    });

    all.push({cycle:c+1, days});
  }
  return all;
}

/* ===== UI ===== */
document.getElementById("therapyForm").addEventListener("submit",e=>{
  e.preventDefault();

  const start=new Date(document.getElementById("startdatum").value);
  const schema=JSON.parse(
    document.getElementById("schema-EC-q2w").textContent
  );

  const cycles=calculateCycles(start,schema);

  /* ---- Graphic: only first cycle ---- */
  const c=cycles[0];
  let gHTML=`<div class="cycle-title">Zyklus 1</div><div class="grid">`;

  c.days.forEach(d=>{
    gHTML+=`<div class="day">`;

    if(d.day===1 || d.day===8){
      gHTML+=`<div class="day-label">d${d.day}</div>`;
    }

    d.events.forEach(ev=>{
      if(ev.type==="therapy")
        gHTML+=`<div class="therapy">${ev.label}</div>`;
      if(ev.type==="injection")
        gHTML+=`<div class="icon">ðŸ’‰</div>`;
      if(ev.type==="lab")
        gHTML+=`<div class="icon">ðŸ©¸</div>`;
    });

    gHTML+=`</div>`;
  });

  gHTML+=`</div>`;
  document.getElementById("graphic").innerHTML=gHTML;

  /* ---- Table: all cycles ---- */
  let table=`
    <table>
      <tr>
        <th>Zyklus</th>
        <th>Datum</th>
        <th>Tag</th>
        <th>MaÃŸnahme</th>
      </tr>`;

  cycles.forEach(c=>{
    c.days.forEach(d=>{
      d.events.forEach(ev=>{
        table+=`
          <tr>
            <td>${c.cycle}</td>
            <td>${fmt(d.date)}</td>
            <td>d${d.day}</td>
            <td>${ev.label}</td>
          </tr>`;
      });
    });
  });

  table+=`</table>`;
  document.getElementById("table").innerHTML=table;

  document.getElementById("plan").style.display="block";
});
</script>
</body>
</html>