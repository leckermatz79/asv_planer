<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Therapieplan ‚Äì Onkologie</title>

<style>
  body { font-family: system-ui, sans-serif; background:#f3f4f6; padding:2rem; }
  .container { max-width:1100px; margin:auto; }

  form, .plan {
    background:#fff; padding:1.5rem; border-radius:12px; margin-bottom:2rem;
    box-shadow:0 10px 25px rgba(0,0,0,0.08);
  }

  label { font-weight:600; font-size:0.85rem; display:block; }
  input, button { width:100%; padding:0.6rem; margin-top:0.25rem; }
  button {
    background:#dc2626; color:#fff; border:none; border-radius:8px;
    font-weight:600; cursor:pointer;
  }

  .warning { color:#dc2626; font-weight:600; }

  /* ===== Grafik-Styles ===== */
  .weekday-header{
    display:grid; grid-template-columns:repeat(7,1fr);
    text-align:center; font-weight:600; font-size:0.75rem;
    margin-bottom:6px; color:#374151;
  }
  .grid{ display:grid; grid-template-columns:repeat(7,1fr); gap:6px; }
  .day {
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    min-height: 110px;
    padding: 10px 5px; /* Etwas mehr vertikaler Platz */
    background: #f9fafb;
    position: relative;
    display: flex;
    /* Dies zentriert die Balken und Icons horizontal als Gruppe */
    justify-content: center; 
    align-items: stretch;
    gap: 12px; /* Abstand zwischen Balken und Icons */
  }

  .day.weekend{ background:#e5e7eb; }
  .day.holiday{ outline:2px solid #dc2626; outline-offset:-2px; }
  
  .therapy-bars {
    display: flex;
    gap: 5px;
    flex-shrink: 0;
    /* Kein festes 'width' mehr, damit es sich zentriert */
  }

  .bar {
    width: 30px; /* Hier die Breite der Balken einstellen - jetzt breiter */
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 800; /* Noch etwas fetter f√ºr bessere Lesbarkeit */
    color: #fff;
    font-size: 0.7rem;
    box-shadow: inset 0 0 4px rgba(0,0,0,0.15);
    /* Schreibt den Buchstaben vertikal, falls er zu breit f√ºr 15px ist */
    writing-mode: vertical-rl; 
    text-orientation: upright;
    padding: 4px 0;
  }

  .day-content {
    /* Kein 'flex: 1' mehr, damit die Gruppe in der Mitte bleibt */
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
  }

  .icon-block {
    text-align: center;
  }

  .icon {
    font-size: 2.2rem;
    line-height: 1;
    margin-bottom: 2px;
  }

  .icon-label {
    font-size: 0.65rem;
    font-weight: 700;
    color: #374151;
    white-space: nowrap;
  }

  .day-label {
    position: absolute;
    bottom: 4px;
    right: 6px;
    font-size: 0.7rem;
    font-weight: 800;
    color: #9ca3af;
  }

  .legend { display:flex; flex-wrap:wrap; gap:16px; font-size:0.8rem; margin-top: 1rem; }
  .legend-item { display:flex; align-items:center; gap:8px; }
  .legend-bar { width:18px; height:18px; border-radius:4px; }

  table{ width:100%; border-collapse:collapse; margin-top:1rem; }
  th, td{ padding:0.5rem; border-bottom:1px solid #e5e7eb; text-align:left; }

  /* ===== DRUCK-LOGIK ===== */
  @page {
    size: landscape;
    margin: 10mm;
  }
  @media print {
    @page { size: A4 landscape; margin: 10mm; }
  }
  @media print {
    form, button, h1, h2, .no-print { display: none !important; }
    body { background: #fff; padding: 0; margin: 0; }
    .container { max-width: 100%; width: 100%; margin: 0; }
    .plan { box-shadow: none; padding: 0; border: none; }

    /* Sichtbarkeit steuern */
    #patient, #graphic, #legend, #table { display: none; }

    body.print-graphic #patient,
    body.print-graphic #graphic,
    body.print-graphic #legend { 
      display: block !important; 
    }

    body.print-table #patient,
    body.print-table #table { 
      display: block !important; 
    }

    /* Sicherstellen, dass Farben gedruckt werden (Safari/Webkit) */
    * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
  }
  /* Safari Druck-Fix f√ºr Farben */
  @media print {
    * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
    .day { border: 1px solid #ccc !important; }
  }
</style>
</head>

<body>
<div class="container">
  <h1 id="title">Therapieplan Erstellung</h1>

  <form id="therapyForm">
    <label>Vorname<input id="vorname" required></label>
    <label>Nachname<input id="nachname" required></label>
    <label>Geburtsdatum (optional, TT.MM.JJJJ)
      <input id="geburt" placeholder="TT.MM.JJJJ">
    </label>
    <label>Chemotherapie-Schema<select id="schemaSelect" required></select></label>
    <label>Startdatum Zyklus 1
      <input type="date" id="startdatum" required>
    </label>
    <button type="submit">Plan berechnen</button>
  </form>

  <div class="plan" id="plan" style="display:none">
    <div id="patient"></div>
    
    <div id="graphic-container">
        <h2 class="no-print">Grafische √úbersicht (1 Zyklus)</h2>
        <div id="graphic"></div>
        <div id="legend"></div>
    </div>

    <div class="no-print" style="margin:2rem 0; display:flex; gap:1rem; background: #eee; padding: 1rem; border-radius: 8px;">
        <button type="button" onclick="printGraphic()">Grafik drucken (Querformat)</button>
        <button type="button" onclick="printTable()">Tabelle drucken (Hochformat)</button>
    </div>

    <div id="table-container">
        <h2 class="no-print">Tabellarische √úbersicht (alle Zyklen)</h2>
        <div id="table"></div>
    </div>
  </div>
</div>

<script type="application/json" id="schemas">
{
  "EC_q2w": {
    "label": "EC q2w",
    "zyklus_tage": 14,
    "anzahl_zyklen": 4,
    "events": [
      { "type": "therapy", "drug": "Epirubicin", "short": "E", "color": "#dc2626", "day": 1 },
      { "type": "therapy", "drug": "Cyclophosphamid", "short": "C", "color": "#2563eb", "day": 1 },
      { "type": "injection", "label": "Pegfilgrastim", "day": 2 },
      { "type": "lab", "label": "Labor", "day": 8 },
      { "type": "lab", "label": "Labor", "workdays_before_next_cycle_start": 2 }
    ]
  },
  "EC_q3w": {
    "label": "EC q3w",
    "zyklus_tage": 21,
    "anzahl_zyklen": 4,
    "events": [
      { "type": "therapy", "drug": "Epirubicin", "short": "E", "color": "#dc2626", "day": 1 },
      { "type": "therapy", "drug": "Cyclophosphamid", "short": "C", "color": "#2563eb", "day": 1 },
      { "type": "lab", "label": "Labor", "day": 8 },
      { "type": "lab", "label": "Labor", "workdays_before_next_cycle_start": 2 }
    ]
  },
  "Paclitaxel_qw": {
    "label": "Paclitaxel w√∂chentlich",
    "zyklus_tage": 7,
    "anzahl_zyklen": 12,
    "events": [
      { "type": "therapy", "drug": "Paclitaxel", "short": "Pac", "color": "#059669", "day": 1 },
      { "type": "lab", "label": "Labor", "workdays_before_next_cycle_start": 2 }
    ]
  },
  "Paclitaxel_Pembro_q3w": {
    "label": "Paclitaxel qw, Pembrolizumab q3w",
    "zyklus_tage": 21,
    "anzahl_zyklen": 4,
    "events": [
      { "type": "therapy", "drug": "Paclitaxel", "short": "Pac", "color": "#059669", "day": 1 },    
      { "type": "therapy", "drug": "Pembrolizumab", "short": "Pem", "color": "#8b5cf6", "day": 1 },      
      { "type": "therapy", "drug": "Paclitaxel", "short": "Pac", "color": "#059669", "day": 8 },
      { "type": "therapy", "drug": "Paclitaxel", "short": "Pac", "color": "#059669", "day": 15 },         
      { "type": "lab", "label": "Labor", "workdays_before_next_cycle_start": 2 },
      { "type": "lab", "label": "Labor", "workdays_before_next_cycle_start": 7 },
      { "type": "lab", "label": "Labor", "workdays_before_next_cycle_start": 12 }
    ]
  },
  "EC_Pembro_q3w": {
    "label": "EC-Pembrolizumab q3w",
    "zyklus_tage": 21,
    "anzahl_zyklen": 4,
    "events": [
      { "type": "therapy", "drug": "Epirubicin", "short": "E", "color": "#dc2626", "day": 1 },
      { "type": "therapy", "drug": "Cyclophosphamid", "short": "C", "color": "#2563eb", "day": 1 },
      { "type": "therapy", "drug": "Pembrolizumab", "short": "Pem", "color": "#8b5cf6", "day": 1 },      
      { "type": "lab", "label": "Labor", "day": 8 },
      { "type": "lab", "label": "Labor", "workdays_before_next_cycle_start": 2 }
    ]
  },
  "TCbHP_q3w": {
    "label": "Docetaxel, Carboplatin, Trastuzumab, Pertuzumab q3w",
    "zyklus_tage": 21,
    "anzahl_zyklen": 6,
    "events": [
      { "type": "therapy", "drug": "Docetaxel", "short": "T", "color": "#059669", "day": 1 },    
      { "type": "therapy", "drug": "Carboplatin", "short": "Cb", "color": "#f59e0b", "day": 1 },      
      { "type": "therapy", "drug": "Trastuzumab", "short": "Her", "color": "#7c3aed", "day": 1 },
      { "type": "therapy", "drug": "Pertuzumab", "short": "Per", "color": "#c026d3", "day": 1 },     
      { "type": "injection", "label": "Pegfilgrastim", "day": 3 },    
      { "type": "lab", "label": "Labor", "workdays_before_next_cycle_start": 2 },
      { "type": "lab", "label": "Labor", "day": 8 }
    ]
  },
  "Paclitaxel_Tratuzumab_Pertuzumab_q3w": {
    "label": "Paclitaxel w√∂chentlich, Trastuzumab/Pertuzumab alle 3 Wochen",
    "zyklus_tage": 21,
    "anzahl_zyklen": 4,
    "events": [
      { "type": "therapy", "drug": "Paclitaxel", "short": "Pac", "color": "#059669", "day": 1 },    
      { "type": "therapy", "drug": "Trastuzumab", "short": "Her", "color": "#7c3aed", "day": 1 },
      { "type": "therapy", "drug": "Pertuzumab", "short": "Per", "color": "#c026d3", "day": 1 },  
      { "type": "therapy", "drug": "Paclitaxel", "short": "Pac", "color": "#059669", "day": 8 },
      { "type": "therapy", "drug": "Paclitaxel", "short": "Pac", "color": "#059669", "day": 15 },         
      { "type": "lab", "label": "Labor", "workdays_before_next_cycle_start": 2 },
      { "type": "lab", "label": "Labor", "workdays_before_next_cycle_start": 7 },
      { "type": "lab", "label": "Labor", "workdays_before_next_cycle_start": 12 }
    ]
  }
}
</script>

<script>
const schemas = JSON.parse(document.getElementById("schemas").textContent);
const schemaSelect = document.getElementById("schemaSelect");
Object.entries(schemas).forEach(([key, schema]) => {
  const opt = document.createElement("option");
  opt.value = key; opt.textContent = schema.label;
  schemaSelect.appendChild(opt);
});

const formEl = document.getElementById("therapyForm");
const vornameEl = document.getElementById("vorname");
const nachnameEl = document.getElementById("nachname");
const geburtEl = document.getElementById("geburt");
const startEl = document.getElementById("startdatum");
const planEl = document.getElementById("plan");
const graphicEl = document.getElementById("graphic");
const patientEl = document.getElementById("patient");
const tableEl = document.getElementById("table");

const weekdays = ["Sonntag","Montag","Dienstag","Mittwoch","Donnerstag","Freitag","Samstag"];
const MS_DAY = 24*60*60*1000;
const addDays = (d,n) => { const x=new Date(d); x.setDate(x.getDate()+n); return x; };
const fmt = d => d.toLocaleDateString("de-DE");

function isValidBirthdate(value){
  if (!value) return true;
  const m = value.match(/^(\d{2})\.(\d{2})\.(\d{4})$/);
  if (!m) return false;
  const d = new Date(parseInt(m[3],10), parseInt(m[2],10)-1, parseInt(m[1],10));
  return d instanceof Date && !isNaN(d) && d <= new Date();
}

function easterSunday(y){
  const f=Math.floor, G=y%19, C=f(y/100);
  const H=(C-f(C/4)-f((8*C+13)/25)+19*G+15)%30;
  const I=H-f(H/28)*(1-f(29/(H+1))*f((21-G)/11));
  const J=(y+f(y/4)+I+2-C+f(C/4))%7;
  const L=I-J;
  return new Date(y,2,28+L);
}

function getNRWHolidays(year){
  const e = easterSunday(year);
  return [
    new Date(year,0,1), new Date(year,4,1), new Date(year,9,3), new Date(year,11,25), new Date(year,11,26),
    addDays(e,-2), addDays(e,1), addDays(e,39), addDays(e,50), addDays(e,60)
  ].map(d => d.toISOString().slice(0,10));
}

function isNRWHoliday(date){ return getNRWHolidays(date.getFullYear()).includes(date.toISOString().slice(0,10)); }
function isWeekend(date){ return date.getDay() === 0 || date.getDay() === 6; }
function isWorkday(date){ return !isWeekend(date) && !isNRWHoliday(date); }

function subtractWorkdays(date, n){
  const x = new Date(date);
  while(n > 0){ x.setDate(x.getDate() - 1); if (isWorkday(x)) n--; }
  return x;
}

function buildCycles(startDate, schema){
  const cycles = [];  
  for (let c = 0; c < schema.anzahl_zyklen; c++){
    const cycleStart = addDays(startDate, c * schema.zyklus_tage);
    const nextCycleStart = addDays(cycleStart, schema.zyklus_tage);
    const days = Array.from({length: schema.zyklus_tage}, (_,i)=>({
      day: i+1, date: addDays(cycleStart, i), events: []
    }));
    for (const ev of schema.events){
      let dIdx = null;
      if (typeof ev.day === "number") dIdx = ev.day;
      if (typeof ev.workdays_before_next_cycle_start === "number") {
        const target = subtractWorkdays(nextCycleStart, ev.workdays_before_next_cycle_start);
        dIdx = Math.round((target - cycleStart) / MS_DAY) + 1;
      }
      if (dIdx && dIdx >= 1 && dIdx <= schema.zyklus_tage) days[dIdx-1].events.push(ev);
    }
    cycles.push({ index: c+1, days });
  }
  return cycles;
}

function renderLegend(schema){
  const items = [];
  const therapies = schema.events.filter(e => e.type === "therapy");
  const uniqueTherapies = {};
  therapies.forEach(t => uniqueTherapies[t.short || t.drug] = t);
  Object.values(uniqueTherapies).forEach(t => {
    items.push(`<div class="legend-item"><div class="legend-bar" style="background:${t.color}"></div><span>${t.drug}</span></div>`);
  });
  if (schema.events.some(e => e.type === "injection")) items.push(`<div class="legend-item"><span>üíâ</span><span>Pegfilgrastim</span></div>`);
  if (schema.events.some(e => e.type === "lab")) items.push(`<div class="legend-item"><span>ü©∏</span><span>Labor</span></div>`);
  document.getElementById("legend").innerHTML = `<div class="legend">${items.join("")}</div>`;
}

// function renderGraphicOneCycle(cycle){
//   let html = `<div class="weekday-header">` + cycle.days.slice(0,7).map(d => `<div>${weekdays[d.date.getDay()]}</div>`).join("") + `</div>`;
//   html += `<div class="grid">` + cycle.days.map(d => {
//     const cls = (isWeekend(d.date) ? "weekend " : "") + (isNRWHoliday(d.date) ? "holiday" : "");
//     let content = "";
//     const therapies = d.events.filter(ev => ev.type === "therapy");
//     if (therapies.length > 0) {
//         content += `<div class="therapy-bars">` + therapies.map(t => `<div class="bar" style="background:${t.color}">${t.short}</div>`).join("") + `</div>`;
//     }
//     d.events.forEach(ev => {
//       if(ev.type === "injection") content += `<div class="icon-block"><div class="icon">üíâ</div><div class="icon-label">${ev.label}</div></div>`;
//       if(ev.type === "lab") content += `<div class="icon-block"><div class="icon">ü©∏</div><div class="icon-label">${ev.label}</div></div>`;
//     });
//     const label = (d.day === 1 || d.day === 8) ? `<div class="day-label">d${d.day}</div>` : "";
//     return `<div class="day ${cls}">${content}${label}</div>`;
//   }).join("") + `</div>`;
//   graphicEl.innerHTML = html;
// }

function renderGraphicOneCycle(cycle){
  let html = `<div class="weekday-header">` + cycle.days.slice(0,7).map(d => `<div>${weekdays[d.date.getDay()]}</div>`).join("") + `</div>`;
  html += `<div class="grid">` + cycle.days.map(d => {
    const cls = (isWeekend(d.date) ? "weekend " : "") + (isNRWHoliday(d.date) ? "holiday" : "");
    
    // Balken-Bereich
    const therapies = d.events.filter(ev => ev.type === "therapy");
    let barHtml = "";
    if (therapies.length > 0) {
        barHtml = `<div class="therapy-bars">` + therapies.map(t => `<div class="bar" style="background:${t.color}">${t.short}</div>`).join("") + `</div>`;
    }

    // Icon- & Label-Bereich
    let iconsHtml = "";
    d.events.forEach(ev => {
      if(ev.type === "injection") iconsHtml += `<div class="icon-block"><div class="icon">üíâ</div><div class="icon-label">${ev.label}</div></div>`;
      if(ev.type === "lab") iconsHtml += `<div class="icon-block"><div class="icon">ü©∏</div><div class="icon-label">${ev.label}</div></div>`;
    });

    const dayLabel = (d.day === 1 || d.day === 8) ? `<div class="day-label">d${d.day}</div>` : "<div></div>";

    return `
      <div class="day ${cls}">
        ${barHtml}
        <div class="day-content">
          ${iconsHtml}
          ${dayLabel}
        </div>
      </div>`;
  }).join("") + `</div>`;
  graphicEl.innerHTML = html;
}

function renderTableAllCycles(cycles){
  let html = `
    <table>
      <tr>
        <th>Datum</th>
        <th>Zyklus</th>
        <th>Tag</th>
        <th>Ma√ünahme</th>
        <th>Hinweis</th>
      </tr>`;

  cycles.forEach(cyc => {
    cyc.days.forEach(d => {

      if (d.events.length === 0) return; // Nur Tage mit Events anzeigen

      // Ma√ünahmen sammeln
      const measures = d.events.map(ev => ev.drug || ev.label).join(", ");

      // Hinweis
      let hint = "";
      if (isNRWHoliday(d.date)) hint = "‚ö†Ô∏è Feiertag";
      else if (isWeekend(d.date)) hint = "‚ö†Ô∏è WE";

      html += `
        <tr>
          <td>${fmt(d.date)}</td>
          <td>${cyc.index}</td>
          <td>d${d.day}</td>
          <td>${measures}</td>
          <td class="warning">${hint}</td>
        </tr>`;
    });
  });

  html += `</table>`;
  tableEl.innerHTML = html;
}

/* ===== DRUCK-FUNKTIONEN ===== */
function printGraphic(){
  document.body.classList.remove("print-table");
  document.body.classList.add("print-graphic");
  window.print();
}

function printTable(){
  document.body.classList.remove("print-graphic");
  document.body.classList.add("print-table");
  window.print();
}

// formEl.addEventListener("submit", (e)=>{
//   e.preventDefault();
//   const geburt = geburtEl.value.trim();
//   if (!isValidBirthdate(geburt)) { alert("Geburtsdatum pr√ºfen!"); return; }
  
//   const startDate = new Date(startEl.value + 'T12:00:00');
//   if (!isWorkday(startDate)){ alert("Startdatum muss ein Arbeitstag sein!"); return; }

//   const schema = schemas[schemaSelect.value];
//   const cycles = buildCycles(startDate, schema);

//   patientEl.innerHTML = `
//     <div style="border-bottom: 2px solid #333; margin-bottom: 20px; padding-bottom: 10px;">
//       <h2 style="margin:0; color:#dc2626; font-size: 1.6rem;">Therapieplan: ${schema.label}</h2>
//       <p style="margin:5px 0; font-size: 1.1rem;">
//         <strong>Patient:</strong> ${vornameEl.value} ${nachnameEl.value} | 
//         <strong>Geburtsdatum:</strong> ${geburt || "‚Äî"}<br>
//         <small>Erstellt am: ${new Date().toLocaleDateString("de-DE")}</small>
//       </p>
//     </div>`;

//   renderGraphicOneCycle(cycles[0]);
//   renderLegend(schema);
//   renderTableAllCycles(cycles);
//   planEl.style.display = "block";
//   planEl.scrollIntoView({ behavior: 'smooth' });
// });

formEl.addEventListener("submit", (e)=>{
  e.preventDefault();
  const geburt = geburtEl.value.trim();
  if (!isValidBirthdate(geburt)) { alert("Geburtsdatum pr√ºfen!"); return; }
  
  const startDate = new Date(startEl.value + 'T12:00:00');
  if (!isWorkday(startDate)){ alert("Startdatum muss ein Arbeitstag sein!"); return; }

  const schema = schemas[schemaSelect.value];
  const cycles = buildCycles(startDate, schema);

  // Der Patientenkopf enth√§lt nun explizit das Schema als Titel
  patientEl.innerHTML = `
    <div style="border-bottom: 2px solid #333; margin-bottom: 20px; padding-bottom: 10px;">
      <h1 style="margin:0 0 10px 0; color:#dc2626; font-size: 1.8rem; display: block !important;">
        Therapieplan: ${schema.label}
      </h1>
      <p style="margin:0; font-size: 1.1rem; line-height: 1.5;">
        <strong>Patient:</strong> ${vornameEl.value} ${nachnameEl.value} | 
        <strong>Geburtsdatum:</strong> ${geburt || "‚Äî"}<br>
        <span style="font-size: 0.9rem; color: #666;">Erstellt am: ${new Date().toLocaleDateString("de-DE")}</span>
      </p>
    </div>`;

  window.onafterprint = () => {
    document.body.classList.remove("print-graphic","print-table");
  };

  renderGraphicOneCycle(cycles[0]);
  renderLegend(schema);
  renderTableAllCycles(cycles);
  planEl.style.display = "block";
  planEl.scrollIntoView({ behavior: 'smooth' });
});

</script>
</body>
</html>